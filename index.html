<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã®ã©ãã‚å›</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="camera.css">
    
    <!-- vConsoleï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«ï¼‰- URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿?dev=trueã§æœ‰åŠ¹åŒ– -->
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§vConsoleã‚’æ¡ä»¶ä»˜ãè¡¨ç¤º
        const urlParams = new URLSearchParams(window.location.search);
        let vConsole = null;
        if (urlParams.get('dev') === 'true') {
            vConsole = new VConsole();
            console.log("Debug Mode: ON");
        } else {
            // vConsoleãŒæœªå®šç¾©ã®å ´åˆã§ã‚‚ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã®ãƒ€ãƒŸãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            vConsole = {
                log: function() {},
                error: function() {},
                warn: function() {},
                info: function() {}
            };
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: sans-serif;
        }

        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
            gap: 0;
            margin: 0;
            padding: 0;
        }

        .left-panel {
            flex: 1;
            overflow: hidden;
            position: relative;
            margin: 0;
            padding: 0;
        }

        .left-panel audio {
            position: absolute;
            visibility: hidden;
        }

        .game-container {
            width: 100%;
            height: 100%;
        }

        .aquarium {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 0;
            box-shadow: none;
        }

        .right-panel {
            width: 400px;
            padding: 0;
            margin: 0;
            background-color: #f5f5f5;
            display: none;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .right-panel.show {
            display: flex;
        }

        #webcam-container {
            position: relative;
            width: 100%;
            flex: 1;
            min-height: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #000;
        }

        #webcam-container canvas {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
        }

        #label-container {
            width: 100%;
            padding: 8px;
            margin: 0;
            flex-shrink: 0;
            background-color: #f5f5f5;
            overflow-y: auto;
            overflow-x: hidden;
            max-height: 150px;
            font-size: 12px;
            line-height: 1.4;
        }

        .camera-start-button {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border: none;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
            transition: all 0.3s ease;
            z-index: 10;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
        }

        .camera-start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
        }

        .camera-start-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .start-button-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            background-color: transparent;
        }

        .start-button-overlay.hidden {
            display: none;
        }

        .unified-progress-container {
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .progress-bar {
            width: 100%;
            height: 16px;
            background-color: #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #4CAF50 0%, #66BB6A 100%);
            transition: width 0.1s ease-out;
            position: absolute;
            left: 0;
            top: 0;
        }

        #orientation-lock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        #orientation-lock-overlay.show {
            display: flex;
        }

        .orientation-lock-content {
            text-align: center;
            color: white;
        }

        .orientation-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: rotate-phone 2s ease-in-out infinite;
        }

        .orientation-message {
            font-size: 24px;
            font-weight: bold;
            line-height: 1.5;
        }

        @keyframes rotate-phone {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
        }

        #version-display {
            position: fixed;
            top: 8px;
            left: 8px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            z-index: 100;
            pointer-events: none;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div id="version-display">v1.0.6</div>

    <div id="orientation-lock-overlay">
        <div class="orientation-lock-content">
            <div class="orientation-icon">ğŸ“±â†»</div>
            <div class="orientation-message">ã‚¹ãƒãƒ›ã®å‘ãã‚’æ¨ªå‘ãã«ã—ã¦ä¸‹ã•ã„</div>
        </div>
    </div>

    <div class="container">
        <div class="left-panel">
            <div class="game-container">
                <div class="aquarium">
                    <div class="bubbles" id="bubbles"></div>
                    <div class="fish-container" id="fish-container">
                        <div class="fish" id="fish">
                            <img src="left_nodo.png" alt="ã®ã©ãã‚å›" id="fish-image">
                        </div>
                    </div>
                    <div class="countdown" id="countdown">
                        <p>ã®ã©ãã‚å›ç™»å ´ã¾ã§: <span id="countdown-timer">10</span>ç§’</p>
                    </div>
                    <div class="suffering-message" id="suffering-message">
                        <p>ã®ã©ãã‚å›ã‚’åŠ©ã‘ã¦ï¼</p>
                    </div>
                </div>
            </div>
            <audio id="bubbling-sound" preload="auto" loop>
                <source src="oyogenodogurokun.mp3" type="audio/mpeg">
            </audio>
        </div>

        <div id="start-button-overlay" class="start-button-overlay">
            <button id="start-camera-btn" class="camera-start-button">ãƒªãƒãƒ“ãƒªã‚’å§‹ã‚ã‚‹</button>
        </div>

        <div class="right-panel" id="right-panel">
            <div id="webcam-container"></div>
            <div id="label-container"></div>
        </div>
    </div>

    <!-- ã™ã¹ã¦ã®JavaScriptã¯</body>ã®ç›´å‰ã«é…ç½® -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script src="script.js"></script>
    <script src="camera.js"></script>

    <script>
        // ãƒ¢ãƒ‡ãƒ«ãƒ‘ã‚¹
        const MODEL_PATH = "./model/";
        let model, webcam, labelContainer, maxPredictions;

        // ç”»é¢å‘ããƒã‚§ãƒƒã‚¯
        function checkOrientation() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const orientationOverlay = document.getElementById('orientation-lock-overlay');
            const mainContainer = document.querySelector('.container');
            
            if (height > width) {
                orientationOverlay.classList.add('show');
                if (mainContainer) mainContainer.style.pointerEvents = 'none';
            } else {
                orientationOverlay.classList.remove('show');
                if (mainContainer) mainContainer.style.pointerEvents = 'auto';
            }
        }
        checkOrientation();
        window.addEventListener('resize', checkOrientation);
        window.addEventListener('orientationchange', checkOrientation);

        // LIFFåˆæœŸåŒ–
        async function initializeLiff() {
            try {
                await liff.init({ liffId: '2008915520-PNmQi9GW' });
            } catch (error) {
                console.error('LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // inité–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§å®šç¾©ï¼ˆiOSå¯¾å¿œç‰ˆï¼‰
        window.init = async function() {
            try {
                // 1. webcam-containerã®å­˜åœ¨ç¢ºèªï¼ˆæœ€é‡è¦ï¼‰
                const webcamContainer = document.getElementById("webcam-container");
                if (!webcamContainer) {
                    alert("äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼: ã‚«ãƒ¡ãƒ©è¡¨ç¤ºå ´æ‰€ãŒã‚ã‚Šã¾ã›ã‚“");
                    return;
                }

                // label-containerã®å–å¾—
                labelContainer = document.getElementById("label-container");
                if (!labelContainer) {
                    console.warn("label-containerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                }

                // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                const startBtn = document.getElementById("start-camera-btn");
                if (startBtn) {
                    startBtn.disabled = true;
                    startBtn.textContent = "èª­ã¿è¾¼ã¿ä¸­...";
                }

                // 2. AIãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã‚ˆã‚Šå…ˆã«ã€webcam.setup()ã‚’å®Ÿè¡Œï¼ˆiOSã®User Gestureå¯¾ç­–ï¼‰
                const flip = true;
                webcam = new tmImage.Webcam(360, 270, flip);
                await webcam.setup();

                // iOSå¯¾ç­–: videoè¦ç´ ã«playsinline, muted, autoplayå±æ€§ã‚’ç¢ºå®Ÿã«ä»˜ä¸
                if (webcam.video) {
                    webcam.video.setAttribute('playsinline', '');
                    webcam.video.setAttribute('muted', '');
                    webcam.video.setAttribute('autoplay', '');
                    webcam.video.playsInline = true;
                    webcam.video.muted = true;
                    webcam.video.autoplay = true;
                }

                // 3. webcam.play()ã‚’å®Ÿè¡Œ
                await webcam.play();
                console.log("ã‚«ãƒ¡ãƒ©èµ·å‹•æˆåŠŸ");

                // 4. webcam-containerã«webcam.canvasã‚’appendChild
                webcamContainer.appendChild(webcam.canvas);

                // 5. ãã®å¾Œã«tmImage.load()ã‚’è¡Œã†
                const modelURL = MODEL_PATH + "model.json";
                const metadataURL = MODEL_PATH + "metadata.json";
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();
                console.log("ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸã€‚ã‚¯ãƒ©ã‚¹æ•°:", maxPredictions);

                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’ä½œæˆ
                if (labelContainer) {
                    const unifiedContainer = document.createElement("div");
                    unifiedContainer.className = "unified-progress-container";
                    const progressBarDiv = document.createElement("div");
                    progressBarDiv.className = "progress-bar";
                    const progressFillDiv = document.createElement("div");
                    progressFillDiv.className = "progress-fill";
                    progressFillDiv.id = "unified-progress-fill";
                    progressFillDiv.style.width = "0%";
                    progressBarDiv.appendChild(progressFillDiv);
                    unifiedContainer.appendChild(progressBarDiv);
                    labelContainer.appendChild(unifiedContainer);
                }

                // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                const startOverlay = document.getElementById("start-button-overlay");
                if (startOverlay) {
                    startOverlay.classList.add("hidden");
                }

                // å³ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
                const rightPanel = document.getElementById("right-panel");
                if (rightPanel) {
                    rightPanel.classList.add("show");
                }

                // 10åŒ¹ã‚’1åŒ¹ã«æ¸›ã‚‰ã™
                if (window.nodoguroGame) {
                    window.nodoguroGame.reduceToSingleFish();
                    window.nodoguroGame.startRehabilitation();
                }

                // äºˆæ¸¬ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
                window.requestAnimationFrame(loop);

            } catch (error) {
                alert("Error: " + error.message);
                console.error("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
                
                // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
                const startBtn = document.getElementById("start-camera-btn");
                if (startBtn) {
                    startBtn.disabled = false;
                    startBtn.textContent = "ãƒªãƒãƒ“ãƒªã‚’å§‹ã‚ã‚‹";
                }
            }
        };

        // äºˆæ¸¬ãƒ«ãƒ¼ãƒ—
        async function loop() {
            if (webcam) {
                webcam.update();
            }
            await predict();
            window.requestAnimationFrame(loop);
        }

        // äºˆæ¸¬ã®å®Ÿè¡Œã¨çµæœã®è¡¨ç¤º
        async function predict() {
            if (!model || !webcam || !labelContainer) {
                return;
            }

            try {
                const prediction = await model.predict(webcam.canvas);
                let isBlowingDetected = false;
                let stretchingPercent = 0;

                for (let i = 0; i < maxPredictions; i++) {
                    if (i >= prediction.length) break;
                    
                    const className = prediction[i].className;
                    const probability = prediction[i].probability.toFixed(2);
                    const percent = Math.round(probability * 100);

                    if (className.includes("ä¼¸ã³ã¦ã‚‹") || className.includes("ä¼¸ã°ã—ã¦ã‚‹")) {
                        stretchingPercent = percent;
                        if (percent >= 80) {
                            isBlowingDetected = true;
                        }
                    }
                }

                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®æ›´æ–°
                const fillElement = document.getElementById("unified-progress-fill");
                if (fillElement) {
                    fillElement.style.width = `${stretchingPercent}%`;
                }

                // ã‚²ãƒ¼ãƒ ã«AIåˆ¤å®šçµæœã‚’é€šçŸ¥
                if (window.nodoguroGame) {
                    window.nodoguroGame.setAIBlowing(isBlowingDetected);
                }
            } catch (error) {
                console.error("äºˆæ¸¬ã‚¨ãƒ©ãƒ¼:", error);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«LIFFåˆæœŸåŒ–ã¨ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®š
        window.addEventListener('DOMContentLoaded', async function() {
            await initializeLiff();
            
            const startBtn = document.getElementById("start-camera-btn");
            if (startBtn) {
                const handleStart = function(e) {
                    try {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        if (typeof tmImage === 'undefined') {
                            alert("AIã®æº–å‚™ä¸­ã§ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚");
                            return;
                        }
                        
                        init();
                    } catch (error) {
                        alert("Error: " + error.message);
                        console.error("ã‚¨ãƒ©ãƒ¼:", error);
                    }
                };
                
                startBtn.addEventListener('click', handleStart, { passive: false });
                startBtn.addEventListener('touchend', handleStart, { passive: false });
                startBtn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    handleStart(e);
                }, { passive: false });
                startBtn.onclick = handleStart;
            }
        });
    </script>
</body>
</html>
